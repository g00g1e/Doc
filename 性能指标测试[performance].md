

## 测试系统简介

性能测试是指通过同时开启大量并发客户端，来评测服务器在一定负载情况的工作表现，从而估算服务器极限处理能力。

性能测试对于服务器性能优化、指导硬件资源的采购、服务缩扩容预警以及容量规划都有着重大意义。

但不同于标准的HTTP协议接口，Matchvs 引擎使用TCP长连接和自定义的二进制协议；同时匹配、对战涉及到大量业务逻辑，因而需要开发配套的测试客户端来模拟大量并发客户端行为。

由于单机硬件资源的限制，整个测试系统是一个分布式架构，系统由 web 控制台、Master、Minion 组成。

web控制台用于测试参数配置，测试结果展示、报表输出等；

Master接收 web 控制台下发的测试任务，将任务分解并分派到各minion模块，并汇总minion上报的客户端侧测试数据，Master还同时负责汇集服务端侧性能数据；

minion是最终完成测试的实体，由 golang 语言编写，使用 goroutine 来模拟大量并发 client，不仅仅可以和master 配合以集群方式运行，还支持单机命令行方式执行（可用于独立部署时的简单压测）。

​	![img](http://imgs.Matchvs.com/static/MatchvsArchitecture/performance.png)

 

## 测试目标

Matchvs 采用多区域，区域内集群化的架构，可以通过节点(set)内水平扩展以及添加新的区域的方式来提升服务能力。

但不少（特别是购买**独立部署**服务或**阿里云镜像**服务的）开发者往往关注一个问题：

**单独一台服务器，部署Matchvs服务可以支持多少同时在线玩家(CCU) ?** 



其实这个问题的答案跟游戏类型有密切关系，诸如

1 每个房间同时有多少个玩家？

2 消息收发量(每个玩家消息收发频率)？

3 信息包体大小 (Bytes)？

4 服务器硬件配置 (CPU、RAM、Network、OS version...)

5 玩家设备平台，游戏对延迟的容忍度等

等因素都会直接影响单机最大CCU。



## 机器规格 

本次性能测试服务器硬件配置以 Matchvs 自用的标准服务器作为评测对象，该机器硬件规格如下：

 

实例类型：ecs.c5.2xlarge

CPU：8 vCPU，Intel Xeon(Skylake) Platinum 8163 2.5 GHz

内存：16 GiB

内网带宽：2.5 Gbps

内网收发包 ：80 万 PPS

磁盘：40G

操作系统：CentOS 7.4 64位

 

## 测试结果

单房间 2 人测试结果 ：

| 单房间人数   | 2        |          |           |         |
| ------------ | -------- | -------- | --------- | ------- |
| 包长         | 1024     |          |           |         |
| 发包频率     | 10       | 20       | 30        | 60      |
| CCU          | 3400     | 2200     | 1900      | 900     |
| CPU使用率    | 308%     | 224%     | 290%      | 185%    |
| 内存使用率   | 37%      | 35%      | 32%       | 31%     |
| 接收包/s     | 30.7K    | 37.0K    | 43.2K     | 45K     |
| 理论收包/s   | 34.0K    | 44.0K    | 57.0K     | 54K     |
| 网卡收包/s   | 84.1K    | 85.5K    | 88.9K     | 92K     |
| 推送包/s     | 58.7K    | 72.2K    | 84.9K     | 89K     |
| 理论推送包/s | 67.9K    | 88.0K    | 114.0K    | 108K    |
| 网卡推送包/s | 93.6K    | 109.2K   | 126.9K    | 132K    |
| 上行         | 31.8MB/s | 38.1MB/s | 44.8MB/s  | 47MB/s  |
| 理论上行     | 34.8MB/s | 45.1MB/s | 58.4MB/s  | 55MB/s  |
| 网卡上行     | 36.9MB/s | 43.3MB/s | 50.4MB/s  | 52MB/s  |
| 下行         | 63.6MB/s | 76.4MB/s | 89.8MB/s  | 94MB/s  |
| 理论下行     | 69.6MB/s | 90.1MB/s | 116.7MB/s | 111MB/s |
| 网卡下行     | 69.0MB/s | 82.6MB/s | 97.7MB/s  | 102MB/s |

 

单房间 6 人测试结果 ：

| 单房间人数   | 6         |         |         |         |
| ------------ | --------- | ------- | ------- | ------- |
| 包长         | 1024      |         |         |         |
| 发包频率     | 10        | 20      | 30      | 60      |
| CCU          | 2400      | 1440    | 1140    | 540     |
| CPU使用率    | 237%      | 233%    | 210%    | 166%    |
| 内存使用率   | 36%       | 33%     | 30%     | 30%     |
| 接收包/s     | 22.4K     | 24K     | 28K     | 27K     |
| 理论收包/s   | 24.0K     | 29K     | 34K     | 32K     |
| 网卡收包/s   | 93.8K     | 96K     | 111K    | 109K    |
| 推送包/s     | 128.5K    | 142K    | 166K    | 162K    |
| 理论推送包/s | 144.0K    | 173K    | 205K    | 194K    |
| 网卡推送包/s | 151.2K    | 164K    | 193K    | 190K    |
| 上行         | 22.6MB/s  | 25MB/s  | 29MB/s  | 29MB/s  |
| 理论上行     | 24.6MB/s  | 29MB/s  | 35MB/s  | 33MB/s  |
| 网卡上行     | 28.6MB/s  | 31MB/s  | 36MB/s  | 36MB/s  |
| 下行         | 135.1MB/s | 150MB/s | 174MB/s | 171MB/s |
| 理论下行     | 147.5MB/s | 177MB/s | 210MB/s | 199MB/s |
| 网卡下行     | 144.0MB/s | 159MB/s | 187MB/s | 185MB/s |

 

单房间 10 人测试结果 ：

| 单房间人数   | 10        |         |         |         |
| ------------ | --------- | ------- | ------- | ------- |
| 包长         | 1024      |         |         |         |
| 发包频率     | 10        | 20      | 30      | 60      |
| CCU          | 1800      | 1050    | 900     | 500     |
| CPU使用率    | 273%      | 219%    | 196%    | 191%    |
| 内存使用率   | 34%       | 32%     | 32%     | 29%     |
| 接收包/s     | 16.5K     | 18K     | 22K     | 21K     |
| 理论收包/s   | 17.8K     | 21K     | 27K     | 30K     |
| 网卡收包/s   | 98.0K     | 104K    | 119K    | 119K    |
| 推送包/s     | 156.3K    | 175K    | 212K    | 211K    |
| 理论推送包/s | 178.2K    | 210K    | 270K    | 300K    |
| 网卡推送包/s | 176.7K    | 192K    | 225K    | 229K    |
| 上行         | 16.7MB/s  | 18MB/s  | 22MB/s  | 22MB/s  |
| 理论上行     | 18.2MB/s  | 22MB/s  | 28MB/s  | 31MB/s  |
| 网卡上行     | 23.3MB/s  | 25MB/s  | 30MB/s  | 30MB/s  |
| 下行         | 164.3MB/s | 184MB/s | 222MB/s | 222MB/s |
| 理论下行     | 182.5MB/s | 215MB/s | 276MB/s | 307MB/s |
| 网卡下行     | 178.1MB/s | 197MB/s | 236MB/s | 237MB/s |

 

单房间 20 人测试结果 ：

| 单房间人数   | 20        |         |         |         |
| ------------ | --------- | ------- | ------- | ------- |
| 包长         | 512       |         |         |         |
| 发包频率     | 10        | 20      | 30      | 60      |
| CCU          | 1300      | 700     | 600     | 300     |
| CPU使用率    | 303%      | 247%    | 218%    | 240%    |
| 内存使用率   | 31%       | 32%     | 29%     | 30%     |
| 接收包/s     | 12K       | 12K     | 14K     | 14K     |
| 理论收包/s   | 13k       | 14K     | 18K     | 18K     |
| 网卡收包/s   | 115K      | 109K    | 125K    | 124K    |
| 推送包/s     | 237K      | 236K    | 284K    | 272K    |
| 理论推送包/s | 260K      | 280K    | 360K    | 360K    |
| 网卡推送包/s | 239K      | 238K    | 276K    | 275K    |
| 上行         | 6.5MB/s   | 6MB/s   | 8MB/s   | 7MB/s   |
| 理论上行     | 6.7MB/s   | 14MB/s  | 18MB/s  | 9MB/s   |
| 网卡上行     | 14.0MB/s  | 14MB/s  | 16MB/s  | 16MB/s  |
| 下行         | 127.7MB/s | 127MB/s | 153MB/s | 146MB/s |
| 理论下行     | 133.1MB/s | 287MB/s | 369MB/s | 184MB/s |
| 网卡下行     | 142.9MB/s | 142MB/s | 171MB/s | 164MB/s |

 

如果想要知道更多机器规格的测试结果，或了解详细测试方法，可加入 QQ 群 （450335262） 咨询。
